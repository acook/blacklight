#!/usr/bin/env bash

source "$(dirname ${BASH_SOURCE[0]})/lib/_shared.bash"
include "bl_env"

mkdir -v -p "$BL_LOCAL_PATH/bin"
safe_cd "$BL_EXT_PATH"

say "installing deps from apt..."
run "apt" sudo apt -y install git curl autoconf

say "obtaining ELLCC..."
ELLCC_FILE=ellcc-x86_64-linux-2017-08-23.bz2
run "download" curl -O "http://ellcc.org/releases/latest/$ELLCC_FILE"
run "extract" tar xvjf "$ELLCC_FILE"
run "cleanup" rm -v "$ELLCC_FILE"

say "obtaining jemalloc..."
run "clone" git clone https://github.com/jemalloc/jemalloc.git

say "building jemalloc..."
safe_cd "$BL_EXT_PATH/jemalloc"
run "cleanup" make relclean
echo -ne "ac_cv_func_secure_getenv=no\nac_cv_func_issetugid=no\n" > config.cache
run "automake" ./autogen.sh -C --prefix "$BL_LOCAL_PATH"
run "make" make
run "install" make install
safe_cd "$BL_EXT_PATH"

ok "everything should be good to go!"
