#!/usr/bin/env bash
# the seemly unnecessary ansieol's work around a bug in some terminals
# that don't draw the background color to the end of the line on newline
# I don't bother trying to fix the banners and other blocks with the same issue

source "$(dirname ${BASH_SOURCE[0]})/lib/_shared.bash"
include "bl_env"

safe_cd "$BL_TEST_DIR"

tmp="/tmp/blacklight_build_test"
log="$tmp/test_$(ts_file).log"

mkdir -v -p "$tmp"

let failures=0
let successes=0

# assume no output, so clean up the previous line
cleanup() { ansiup 1 ; ansigoto 0 ; colorreset ; ansieol ; }

say "running tests..."

say "beginning test run..." > $log

for testfile in ./*_test.c; do
  name="$(basename $testfile)"
  exec="$tmp/$(basename -s "_test.c" $testfile).exe"

  say "compiling and running $name..."

  colorbg yellow ; colorfg black
  echo -n "compiling $name..." ; ansieol ; echo
  colorreset ; colorbg black ; colorfg orangered ; ansieol

  run "compile $name" $BL_CC $testfile -static -Wno-everything $BL_ALLOC -o $exec >> $log
  ret=$?

  if [[ $ret -eq 0 ]]; then
    cleanup ; colorbg yellow ; colorfg black
    echo -n "running $name..." ; ansieol ; echo
    colorreset ; colorbg black ; colorfg orangered ; ansieol

    run "$name" $exec >> $log
    ret=$?
  fi

  if [[ $ret -eq 0 ]]; then
    let successes++

    cleanup ; colorbg green3 ; ansieol
    say "(succeeded) $name" | tee -a $log
  else
    let failures++
    # a blank black line to terminate the output and give it a bit of space
    colorreset ; colorbg black ; ansieol ; echo
    colorbg red3 ; ansieol
    say "(FAILED) $name" | tee -a $log
  fi

  colorreset ; ansieol
done

if [[ $failures -eq 0 ]]; then
  colorbg black ; colorfg green3
  if command_exists figlet; then
    bigsay " $successes/$(($successes + $failures))  tests  succeeded!"
  else
    ansiup 1
    echo "

  .-----.--.--.----.----.-----.-----.-----.
  |__ --|  |  |  __|  __|  -__|__ --|__ --|
  |_____|_____|____|____|_____|_____|_____|
"
  fi
  colorreset ; ansieol

  msg="$successes/$(($successes + $failures)) tests succeeded!"
  echo "$msg" >> $log
  ok "$msg"
else
  colorbg black ; colorfg red3
  if command_exists figlet; then
    bigsay " $failures/$(($successes + $failures))  tests  failed!"
  else
    ansiup 1
    echo "
    ___         __ __
  .'  _|.---.-.|__|  |
  |   _||  _  ||  |  |
  |__|  |___._||__|__|
"
  fi
  colorreset ; ansieol

  exit="$(($failures<255?$failures:255))"
  msg="$failures/$(($successes + $failures)) tests failed!"
  echo "$msg" >> $log
  die_status $exit "$msg"
fi
