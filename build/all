#!/usr/bin/env bash

source "$(dirname ${BASH_SOURCE[0]})/lib/_shared.bash"
include "bl_env"

run_or_die compile $BL_CC "$BL_MAIN_PATH" $BL_CCOPTS
COMPEXIT=$?

if [[ $COMPEXIT -ne 0 ]]; then
  if [[ $CI != true ]]; then
    say "compilation failed!"
    say "launching bash prompt in build environment..."
    bash --norc --noprofile
  fi
  die_status $COMPEXIT "compilation failed!"
fi

say "moving..."
mkdir -p -v "$BL_BIN_DIR"
mv -v "$BL_OUT_NAME" "$BL_BIN_PATH"

run "strip" "$BL_STRIP" "$BL_BIN_PATH"
stat -c "%n %s %A %y" "$BL_BIN_PATH"
file -b "$BL_BIN_PATH"

say "excutable located at $BL_BIN_PATH"

if scriptsame; then
  ok "compilation successful!"
fi
